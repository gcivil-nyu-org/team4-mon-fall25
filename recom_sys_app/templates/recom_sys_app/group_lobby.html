{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Group Lobby - {{ group_code }}</title>
  <style>
    /* ===== CineMatch Group Lobby ============================================= */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(to bottom, #b794f6 0%, #e9d5ff 100%);
      min-height: 100vh;
      padding: 20px;
      color: #4c1d95;
    }

    .lobby-container {
      max-width: 900px;
      margin: 0 auto;
    }

    /* ===== Header Card ============================================================= */
    .lobby-header {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      text-align: center;
      margin-bottom: 30px;
    }

    .lobby-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      color: #4c1d95;
    }

    .group-code-display {
      display: inline-flex;
      align-items: center;
      gap: 16px;
      padding: 20px 28px;
      background: #f9fafb;
      border: 2px solid #8b5cf6;
      border-radius: 12px;
      margin: 20px 0;
    }

    .code-label {
      font-size: 12px;
      color: #6b46c1;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .code-value {
      font-family: 'Courier New', monospace;
      font-size: 32px;
      font-weight: 700;
      letter-spacing: 4px;
      color: #8b5cf6;
    }

    .btn-copy {
      padding: 10px 20px;
      background: linear-gradient(135deg, #8b5cf6 0%, #667eea 100%);
      border: none;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-copy:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }

    .btn-copy.copied {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .invite-text {
      color: #6b46c1;
      font-size: 14px;
      margin-top: 16px;
    }

    /* ===== Members Section ==================================================== */
    .members-section {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      margin-bottom: 30px;
    }

    .members-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
    }

    .members-title {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0;
      color: #4c1d95;
    }

    .member-count {
      background: linear-gradient(135deg, #8b5cf6 0%, #667eea 100%);
      border-radius: 20px;
      padding: 6px 14px;
      font-size: 14px;
      font-weight: 600;
      color: white;
    }

    .members-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .member-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .member-item:hover {
      border-color: #8b5cf6;
      transform: translateX(4px);
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.2);
    }

    .member-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .member-avatar {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #8b5cf6 0%, #667eea 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 700;
      color: white;
      flex-shrink: 0;
    }

    .member-details {
      display: flex;
      flex-direction: column;
    }

    .member-name {
      font-weight: 600;
      color: #4c1d95;
      font-size: 15px;
    }

    .member-username {
      font-size: 13px;
      color: #6b46c1;
    }

    .member-role {
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid;
    }

    .member-role.creator {
      background: rgba(139, 92, 246, 0.1);
      border-color: #8b5cf6;
      color: #6b46c1;
    }

    .member-role.member {
      background: #f3f4f6;
      border-color: #d1d5db;
      color: #6b7280;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #6b46c1;
    }

    .no-members {
      text-align: center;
      padding: 40px;
      color: #6b46c1;
    }

    /* ===== Actions Section ==================================================== */
    .lobby-actions {
      display: flex;
      gap: 16px;
      justify-content: center;
    }

    .btn-primary {
      padding: 16px 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-danger {
      padding: 16px 32px;
      background: #a85537;
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-danger:hover {
      background: #92452a;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(168, 85, 55, 0.3);
    }

    /* ===== Mobile Responsive ================================================== */
    @media (max-width: 600px) {
      body {
        padding: 10px;
      }

      .lobby-header {
        padding: 24px 20px;
      }

      .lobby-title {
        font-size: 24px;
      }

      .code-value {
        font-size: 24px;
        letter-spacing: 2px;
      }

      .group-code-display {
        flex-direction: column;
        gap: 12px;
        padding: 16px;
      }

      .members-section {
        padding: 20px;
      }

      .lobby-actions {
        flex-direction: column;
      }

      .lobby-actions button {
        width: 100%;
      }

      .member-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
    }

    /* ===== Animations ========================================================= */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .lobby-container > * {
      animation: fadeIn 0.4s ease;
    }

    @media (prefers-reduced-motion: reduce) {
      * {
        animation: none !important;
        transition: none !important;
      }
    }
  </style>
</head>
<body>
  <div class="lobby-container">
    <!-- Header -->
    <div class="lobby-header">
      <h1 class="lobby-title">
        <span>üé¨</span>
        Group Lobby
      </h1>

      <div class="group-code-display">
        <div>
          <div class="code-label">GROUP CODE</div>
          <div class="code-value">{{ group_code }}</div>
        </div>
        <button id="copyCodeBtn" class="btn-copy" title="Copy group code">
          üìã Copy
        </button>
      </div>

      <p class="invite-text">Share this code with friends to invite them to your movie session!</p>
    </div>

    <!-- Members Section -->
    <div class="members-section">
      <div class="members-header">
        <h2 class="members-title">
          <span>üë•</span>
          Members
        </h2>
        <span id="memberCount" class="member-count">0</span>
      </div>

      <div id="membersList" class="members-list">
        <div class="loading">Loading members...</div>
      </div>
    </div>

    <!-- Actions -->
    <div class="lobby-actions">
      <button id="startMatchingBtn" class="btn-primary">
        ‚ñ∂Ô∏è Start Matching
      </button>
      <button id="leaveLobbyBtn" class="btn-danger">
        üö™ Leave Lobby
      </button>
    </div>

  <script>
    const groupId = '{{ group.id }}';
    const groupCode = '{{ group_code }}';
    const isCreator = {{ is_creator|yesno:"true,false" }};

    // Load Group Details
    async function loadGroupDetails() {
      try {
        const response = await fetch(`/api/groups/${groupId}`);
        const result = await response.json();

        if (result.success) {
          displayMembers(result.data.members);
          updateMemberCount(result.data.memberCount);
        } else {
          console.error('Failed to load group details:', result.message);
        }
      } catch (error) {
        console.error('Error loading group details:', error);
      }
    }

    // Display Members
    function displayMembers(members) {
      const membersList = document.getElementById('membersList');

      if (members.length === 0) {
        membersList.innerHTML = '<div class="no-members">No members yet. Share the group code to invite friends!</div>';
        return;
      }

      membersList.innerHTML = members.map(member => {
        const displayName = member.name || member.username;
        const initial = displayName.charAt(0).toUpperCase();
        const email = member.email || `@${member.username}`;

        return `
          <div class="member-item">
            <div class="member-info">
              <div class="member-avatar">${initial}</div>
              <div class="member-details">
                <span class="member-name">${displayName}</span>
                <span class="member-username">${email}</span>
              </div>
            </div>
            <span class="member-role ${member.role.toLowerCase()}">${member.role}</span>
          </div>
        `;
      }).join('');
    }

    // Update Member Count
    function updateMemberCount(count) {
      document.getElementById('memberCount').textContent = count;
    }

    // Copy Group Code
    document.getElementById('copyCodeBtn').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(groupCode);
        const btn = document.getElementById('copyCodeBtn');
        const originalText = btn.innerHTML;

        btn.innerHTML = '‚úì Copied!';
        btn.classList.add('copied');

        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.classList.remove('copied');
        }, 2000);
      } catch (error) {
        // Fallback for browsers that don't support clipboard API
        const textArea = document.createElement('textarea');
        textArea.value = groupCode;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          alert('Group code copied: ' + groupCode);
        } catch (err) {
          alert('Failed to copy. Group code: ' + groupCode);
        }
        document.body.removeChild(textArea);
      }
    });

    // Start Matching
    document.getElementById('startMatchingBtn').addEventListener('click', () => {
      // Áõ¥Êé•Ë∑≥ËΩ¨Âà∞ deck È°µÈù¢
      window.location.href = `/groups/${groupCode}/deck/`;
    });

    // Leave Lobby
    document.getElementById('leaveLobbyBtn').addEventListener('click', () => {
      if (confirm('Are you sure you want to leave this group?')) {
        window.location.href = '/profile/';
      }
    });

    // Load group details on page load
    loadGroupDetails();

    // Auto-refresh members list every 5 seconds
    setInterval(loadGroupDetails, 5000);
  </script>
</body>
</html>
