{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% if is_community %}Community Lobby{% else %}Group Lobby{% endif %} - {{ group_code }}</title>
  <style>
    /* ===== CineMatch Group Lobby ============================================= */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #141414;
      min-height: 100vh;
      padding: 20px;
      color: #fff;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image:
        url('{% static "recom_sys_app/images/Gemini_Generated_Image_bh81l1bh81l1bh81.png" %}'),
        url('{% static "recom_sys_app/images/6cb18e0d07fa3ab0c15de17289acc907.jpg" %}'),
        url('{% static "recom_sys_app/images/images.png" %}');
      background-size: cover, cover, cover;
      background-position: center top, center center, center bottom;
      background-repeat: no-repeat;
      background-blend-mode: screen, lighten, overlay;
      opacity: 0.25;
      z-index: 0;
      filter:
        brightness(0.4)
        contrast(1.8)
        saturate(0)
        sepia(100%)
        hue-rotate(345deg)
        drop-shadow(0 0 40px rgba(229, 9, 20, 0.6))
        drop-shadow(0 0 20px rgba(229, 9, 20, 0.5))
        drop-shadow(0 0 10px rgba(229, 9, 20, 0.4));
      mix-blend-mode: screen;
    }

    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(ellipse at top left, rgba(229, 9, 20, 0.08) 0%, transparent 60%),
        radial-gradient(ellipse at bottom right, rgba(229, 9, 20, 0.06) 0%, transparent 60%),
        radial-gradient(ellipse at center, rgba(229, 9, 20, 0.03) 0%, transparent 70%),
        linear-gradient(
          135deg,
          rgba(229, 9, 20, 0.05) 0%,
          rgba(20, 20, 20, 0.95) 50%,
          rgba(0, 0, 0, 0.98) 100%
        );
      z-index: 1;
      pointer-events: none;
    }

    .lobby-container {
      max-width: 900px;
      margin: 0 auto;
      position: relative;
      z-index: 2;
    }

    /* ===== Header Card ============================================================= */
    .lobby-header {
      background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      text-align: center;
      margin-bottom: 30px;
    }

    .lobby-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      color: #fff;
    }

    .group-code-display {
      display: inline-flex;
      align-items: center;
      gap: 16px;
      padding: 20px 28px;
      background: rgba(0, 0, 0, 0.4);
      border: 2px solid rgba(229, 9, 20, 0.5);
      border-radius: 12px;
      margin: 20px 0;
    }

    .code-label {
      font-size: 12px;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .code-value {
      font-family: 'Courier New', monospace;
      font-size: 32px;
      font-weight: 700;
      letter-spacing: 4px;
      color: #E50914;
    }

    .btn-copy {
      padding: 10px 20px;
      background: #E50914;
      border: none;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-copy:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }

    .btn-copy.copied {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .invite-text {
      color: #E50914;
      font-size: 14px;
      margin-top: 16px;
    }

    /* ===== Members Section ==================================================== */
    .members-section {
      background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      margin-bottom: 30px;
    }

    .members-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
    }

    .members-title {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0;
      color: #fff;
    }

    .member-count {
      background: #E50914;
      border-radius: 20px;
      padding: 6px 14px;
      font-size: 14px;
      font-weight: 600;
      color: white;
    }

    .members-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .member-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .member-item:hover {
      border-color: #E50914;
      transform: translateX(4px);
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.2);
    }

    .member-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .member-avatar {
      width: 48px;
      height: 48px;
      background: #E50914;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 700;
      color: white;
      flex-shrink: 0;
    }

    .member-details {
      display: flex;
      flex-direction: column;
    }

    .member-name {
      font-weight: 600;
      color: #fff;
      font-size: 15px;
    }

    .member-username {
      font-size: 13px;
      color: #E50914;
    }

    .member-role {
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid;
    }

    .member-role.creator {
      background: rgba(139, 92, 246, 0.1);
      border-color: #E50914;
      color: #E50914;
    }

    .member-role.member {
      background: #f3f4f6;
      border-color: #d1d5db;
      color: #6b7280;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #E50914;
    }

    .no-members {
      text-align: center;
      padding: 40px;
      color: #E50914;
    }

    /* ===== Actions Section ==================================================== */
    .lobby-actions {
      display: flex;
      gap: 16px;
      justify-content: center;
    }

    .btn-primary {
      padding: 16px 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-danger {
      padding: 16px 32px;
      background: #a85537;
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-danger:hover {
      background: #92452a;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(168, 85, 55, 0.3);
    }

    .btn-secondary {
      padding: 16px 32px;
      background: #6b7280;
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-secondary:hover {
      background: #4b5563;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
    }

    /* ===== Mobile Responsive ================================================== */
    @media (max-width: 600px) {
      body {
        padding: 10px;
      }

      .lobby-header {
        padding: 24px 20px;
      }

      .lobby-title {
        font-size: 24px;
      }

      .code-value {
        font-size: 24px;
        letter-spacing: 2px;
      }

      .group-code-display {
        flex-direction: column;
        gap: 12px;
        padding: 16px;
      }

      .members-section {
        padding: 20px;
      }

      .lobby-actions {
        flex-direction: column;
      }

      .lobby-actions button {
        width: 100%;
      }

      .member-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
    }

    /* ===== Animations ========================================================= */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .lobby-container > * {
      animation: fadeIn 0.4s ease;
    }

    @media (prefers-reduced-motion: reduce) {
      * {
        animation: none !important;
        transition: none !important;
      }
    }
  </style>
</head>
<body>
  <div class="lobby-container">
    <!-- Header -->
    <div class="lobby-header">
      <h1 class="lobby-title">
        <span>{% if is_community %}üåê{% else %}üé¨{% endif %}</span>
        {% if is_community %}Community Lobby{% else %}Group Lobby{% endif %}
      </h1>

      <div class="group-code-display">
        <div>
          <div class="code-label">GROUP CODE</div>
          <div class="code-value">{{ group_code }}</div>
        </div>
        <button id="copyCodeBtn" class="btn-copy" title="Copy group code">
          üìã Copy
        </button>
      </div>

      <p class="invite-text">
        {% if is_community %}
          Share this code to invite others to this community!
        {% else %}
          Share this code with friends to invite them to your movie session!
        {% endif %}
      </p>
    </div>

    <!-- Members Section -->
    <div class="members-section">
      <div class="members-header">
        <h2 class="members-title">
          <span>üë•</span>
          Members
        </h2>
        <span id="memberCount" class="member-count">0</span>
      </div>

      <div id="membersList" class="members-list">
        <div class="loading">Loading members...</div>
      </div>
    </div>

    <!-- Chat Section -->
    <div class="members-section" style="margin-top: 30px;">
      <div class="members-header">
        <h2 class="members-title">
          <span>üí¨</span>
          Group Chat
        </h2>
      </div>

      <div id="chatMessages" style="background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 20px; max-height: 300px; overflow-y: auto; margin-bottom: 15px; min-height: 200px;">
        <div style="text-align: center; color: #9ca3af; padding: 40px 20px;">
          No messages yet. Start chatting!
        </div>
      </div>

      <form id="chatForm" onsubmit="sendChatMessage(event)" style="display: flex; gap: 10px;">
        <input
          type="text"
          id="chatInput"
          placeholder="Type a message..."
          style="flex: 1; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; outline: none; transition: border-color 0.2s;"
          onfocus="this.style.borderColor='#8b5cf6'"
          onblur="this.style.borderColor='#e5e7eb'"
        />
        <button
          type="submit"
          style="padding: 12px 24px; background: #E50914; border: none; border-radius: 10px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease;"
          onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(139, 92, 246, 0.4)'"
          onmouseout="this.style.transform=''; this.style.boxShadow=''"
        >
          Send
        </button>
      </form>
    </div>

    <!-- Actions -->
    <div class="lobby-actions">
      <button id="startMatchingBtn" class="btn-primary">
        ‚ñ∂Ô∏è Start Matching
      </button>
      <button id="backToProfileBtn" class="btn-secondary">
        ‚Üê Back to Profile
      </button>
      {% if is_creator %}
      <button id="deleteGroupBtn" class="btn-danger">
        üóëÔ∏è Delete Group
      </button>
      {% else %}
      <button id="leaveLobbyBtn" class="btn-danger">
        üö™ Leave Group
      </button>
      {% endif %}
    </div>

  <script>
    const groupId = '{{ group.id }}';
    const groupCode = '{{ group_code }}';
    const isCreator = {{ is_creator|yesno:"true,false" }};

    // Load Group Details
    async function loadGroupDetails() {
      try {
        const response = await fetch(`/api/groups/${groupId}`);
        const result = await response.json();

        if (result.success) {
          displayMembers(result.data.members);
          updateMemberCount(result.data.memberCount);
        } else {
          console.error('Failed to load group details:', result.message);
        }
      } catch (error) {
        console.error('Error loading group details:', error);
      }
    }

    // Display Members
    function displayMembers(members) {
      const membersList = document.getElementById('membersList');

      if (members.length === 0) {
        membersList.innerHTML = '<div class="no-members">No members yet. Share the group code to invite friends!</div>';
        return;
      }

      membersList.innerHTML = members.map(member => {
        const displayName = member.name || member.username;
        const initial = displayName.charAt(0).toUpperCase();
        const email = member.email || `@${member.username}`;

        return `
          <div class="member-item">
            <div class="member-info">
              <div class="member-avatar">${initial}</div>
              <div class="member-details">
                <span class="member-name">${displayName}</span>
                <span class="member-username">${email}</span>
              </div>
            </div>
            <span class="member-role ${member.role.toLowerCase()}">${member.role}</span>
          </div>
        `;
      }).join('');
    }

    // Update Member Count
    function updateMemberCount(count) {
      document.getElementById('memberCount').textContent = count;
    }

    // Copy Group Code
    document.getElementById('copyCodeBtn').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(groupCode);
        const btn = document.getElementById('copyCodeBtn');
        const originalText = btn.innerHTML;

        btn.innerHTML = '‚úì Copied!';
        btn.classList.add('copied');

        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.classList.remove('copied');
        }, 2000);
      } catch (error) {
        // Fallback for browsers that don't support clipboard API
        const textArea = document.createElement('textarea');
        textArea.value = groupCode;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          alert('Group code copied: ' + groupCode);
        } catch (err) {
          alert('Failed to copy. Group code: ' + groupCode);
        }
        document.body.removeChild(textArea);
      }
    });

    // Start Matching
    document.getElementById('startMatchingBtn').addEventListener('click', () => {
      // Áõ¥Êé•Ë∑≥ËΩ¨Âà∞ deck È°µÈù¢
      window.location.href = `/groups/${groupCode}/deck/`;
    });

    // Back to Profile (for everyone - just navigates back without leaving the group)
    document.getElementById('backToProfileBtn').addEventListener('click', () => {
      window.location.href = '/profile/';
    });

    // Leave Group (for members)
    const leaveLobbyBtn = document.getElementById('leaveLobbyBtn');
    if (leaveLobbyBtn) {
      leaveLobbyBtn.addEventListener('click', async () => {
        if (confirm('Are you sure you want to leave this group? You can rejoin later with the group code.')) {
          try {
            const response = await fetch(`/api/groups/${groupId}/leave/`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
              }
            });
            const data = await response.json();
            if (data.success) {
              alert(data.message);
              window.location.href = '/profile/';
            } else {
              alert(data.message || 'Failed to leave group');
            }
          } catch (error) {
            console.error('Error leaving group:', error);
            alert('Failed to leave group. Please try again.');
          }
        }
      });
    }

    // Delete Group (for creator only)
    const deleteGroupBtn = document.getElementById('deleteGroupBtn');
    if (deleteGroupBtn) {
      deleteGroupBtn.addEventListener('click', async () => {
        if (confirm(`Are you sure you want to DELETE group "${groupCode}"? This action cannot be undone.`)) {
          if (confirm('FINAL WARNING: All group data, matches, and member information will be permanently deleted. Continue?')) {
            try {
              const response = await fetch(`/api/groups/${groupId}/delete/`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': getCookie('csrftoken')
                }
              });
              const data = await response.json();
              if (data.success) {
                alert(data.message);
                window.location.href = '/profile/';
              } else {
                alert(data.message || 'Failed to delete group');
              }
            } catch (error) {
              console.error('Error deleting group:', error);
              alert('Failed to delete group. Please try again.');
            }
          }
        }
      });
    }

    // Helper function to get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Load group details on page load
    loadGroupDetails();

    // Auto-refresh members list every 5 seconds
    setInterval(loadGroupDetails, 5000);

    // ==================== Chat WebSocket ====================
    let chatSocket = null;
    const currentUsername = '{{ request.user.username }}';

    function connectChatWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const chatWsUrl = `${protocol}//${window.location.host}/ws/chat/${groupCode}/`;

      chatSocket = new WebSocket(chatWsUrl);

      chatSocket.onopen = function(e) {
        console.log('[Chat] WebSocket connected');
        loadChatHistory();
      };

      chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.type === 'chat_message') {
          displayChatMessage(data);
        }
      };

      chatSocket.onclose = function(e) {
        console.log('[Chat] WebSocket closed, reconnecting...');
        setTimeout(connectChatWebSocket, 3000);
      };

      chatSocket.onerror = function(e) {
        console.error('[Chat] WebSocket error:', e);
      };
    }

    function sendChatMessage(event) {
      event.preventDefault();
      const input = document.getElementById('chatInput');
      const message = input.value.trim();

      if (message && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.send(JSON.stringify({
          'type': 'chat_message',
          'message': message
        }));
        input.value = '';
      }
    }

    function displayChatMessage(data) {
      const messagesDiv = document.getElementById('chatMessages');

      // Remove "no messages" placeholder if it exists
      if (messagesDiv.querySelector('[style*="text-align: center"]')) {
        messagesDiv.innerHTML = '';
      }

      const isOwnMessage = data.username === currentUsername;
      const messageDiv = document.createElement('div');
      messageDiv.style.cssText = `
        margin-bottom: 12px;
        display: flex;
        flex-direction: column;
        align-items: ${isOwnMessage ? 'flex-end' : 'flex-start'};
      `;

      const time = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      messageDiv.innerHTML = `
        <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">
          ${isOwnMessage ? 'You' : data.username} ‚Ä¢ ${time}
        </div>
        <div style="
          background: ${isOwnMessage ? 'linear-gradient(135deg, #8b5cf6 0%, #667eea 100%)' : '#f3f4f6'};
          color: ${isOwnMessage ? 'white' : '#1f2937'};
          padding: 10px 14px;
          border-radius: 12px;
          max-width: 70%;
          word-wrap: break-word;
        ">
          ${escapeHtml(data.message)}
        </div>
      `;

      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    async function loadChatHistory() {
      try {
        const response = await fetch(`/api/groups/${groupCode}/chat/history/?limit=50`);
        const result = await response.json();

        if (result.success && result.messages.length > 0) {
          const messagesDiv = document.getElementById('chatMessages');
          messagesDiv.innerHTML = '';

          result.messages.forEach(msg => {
            displayChatMessage({
              username: msg.user,
              message: msg.message,
              timestamp: msg.created_at,
              type: 'chat_message'
            });
          });
        }
      } catch (error) {
        console.error('Error loading chat history:', error);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Connect chat WebSocket on page load
    connectChatWebSocket();
  </script>
</body>
</html>
