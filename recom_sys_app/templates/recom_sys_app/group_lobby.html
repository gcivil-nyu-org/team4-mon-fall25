{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Group Lobby - {{ group_code }}</title>
  <style>
    /* ===== CineMatch Group Lobby ============================================= */
    :root {
      --bg: #0b0b10;
      --fg: #e9eaf2;
      --muted: #b5b8c3;
      --card: #151822;
      --card-elev: #1a1e2b;
      --border: #262a3d;
      --accent: #7aa2f7;
      --accent-hover: #8fb2f9;
      --success: #9ece6a;
      --warning: #e0af68;
      --error: #f7768e;

      --radius: 14px;
      --radius-sm: 10px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --ring: 0 0 0 2px rgba(122,162,247,.6);

      --font: -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(1200px 800px at 20% -20%, #121525, transparent 55%),
                  radial-gradient(1000px 600px at 120% 0%, #0e111a, transparent 50%),
                  var(--bg);
      color: var(--fg);
      font: 16px/1.55 var(--font);
      padding: 20px;
    }

    .lobby-container {
      max-width: 900px;
      margin: 0 auto;
    }

    /* ===== Header ============================================================= */
    .lobby-header {
      background: linear-gradient(180deg, var(--card-elev) 0%, var(--card) 100%);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 40px;
      box-shadow: var(--shadow);
      text-align: center;
      margin-bottom: 30px;
    }

    .lobby-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .group-code-display {
      display: inline-flex;
      align-items: center;
      gap: 16px;
      padding: 16px 24px;
      background: #0f1320;
      border: 2px solid var(--accent);
      border-radius: var(--radius-sm);
      margin: 20px 0;
    }

    .code-label {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .code-value {
      font-family: 'Courier New', monospace;
      font-size: 32px;
      font-weight: 700;
      letter-spacing: 4px;
      color: var(--accent);
    }

    .btn-copy {
      padding: 8px 16px;
      background: linear-gradient(135deg, var(--accent), #9d7cd8);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all .2s ease;
      font-size: 14px;
    }

    .btn-copy:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(122,162,247,.4);
    }

    .btn-copy.copied {
      background: linear-gradient(135deg, var(--success), #73e0a9);
    }

    .invite-text {
      color: var(--muted);
      font-size: 14px;
      margin-top: 16px;
    }

    /* ===== Members Section ==================================================== */
    .members-section {
      background: linear-gradient(180deg, var(--card-elev) 0%, var(--card) 100%);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 30px;
      box-shadow: var(--shadow);
      margin-bottom: 30px;
    }

    .members-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .members-title {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0;
    }

    .member-count {
      background: rgba(122,162,247,.12);
      border: 1px solid rgba(122,162,247,.35);
      border-radius: 20px;
      padding: 4px 12px;
      font-size: 14px;
      font-weight: 600;
      color: var(--accent);
    }

    .members-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .member-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: #0f1320;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      transition: all .2s ease;
    }

    .member-item:hover {
      border-color: var(--accent);
      transform: translateX(4px);
    }

    .member-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .member-avatar {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #7aa2f7, #bb9af7);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 700;
      color: white;
      flex-shrink: 0;
    }

    .member-details {
      display: flex;
      flex-direction: column;
    }

    .member-name {
      font-weight: 600;
      color: var(--fg);
      font-size: 15px;
    }

    .member-username {
      font-size: 13px;
      color: var(--muted);
    }

    .member-role {
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .member-role.creator {
      background: linear-gradient(135deg, rgba(122,162,247,.2), rgba(157,122,216,.2));
      border: 1px solid rgba(122,162,247,.5);
      color: var(--accent);
    }

    .member-role.member {
      background: rgba(181,184,195,.12);
      border: 1px solid rgba(181,184,195,.35);
      color: var(--muted);
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }

    .no-members {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }

    /* ===== Actions Section ==================================================== */
    .lobby-actions {
      display: flex;
      gap: 16px;
      justify-content: center;
    }

    .btn-primary {
      padding: 14px 32px;
      background: linear-gradient(135deg, var(--accent), #9d7cd8);
      border: none;
      border-radius: var(--radius-sm);
      color: white;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all .2s ease;
      box-shadow: 0 4px 12px rgba(122,162,247,.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(122,162,247,.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-danger {
      padding: 14px 32px;
      background: rgba(247,118,142,.12);
      border: 1px solid rgba(247,118,142,.35);
      border-radius: var(--radius-sm);
      color: var(--error);
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all .2s ease;
    }

    .btn-danger:hover {
      background: rgba(247,118,142,.2);
      border-color: rgba(247,118,142,.5);
    }

    /* ===== Mobile Responsive ================================================== */
    @media (max-width: 600px) {
      body {
        padding: 10px;
      }

      .lobby-header {
        padding: 24px 20px;
      }

      .lobby-title {
        font-size: 24px;
      }

      .code-value {
        font-size: 24px;
        letter-spacing: 2px;
      }

      .group-code-display {
        flex-direction: column;
        gap: 12px;
        padding: 16px;
      }

      .members-section {
        padding: 20px;
      }

      .lobby-actions {
        flex-direction: column;
      }

      .lobby-actions button {
        width: 100%;
      }

      .member-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
    }

    /* ===== Animations ========================================================= */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .lobby-container > * {
      animation: fadeIn 0.4s ease;
    }

    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }
  </style>
</head>
<body>
  <div class="lobby-container">
    <!-- Header -->
    <div class="lobby-header">
      <h1 class="lobby-title">
        <span>üé¨</span>
        Group Lobby
      </h1>

      <div class="group-code-display">
        <div>
          <div class="code-label">Group Code</div>
          <div class="code-value">{{ group_code }}</div>
        </div>
        <button id="copyCodeBtn" class="btn-copy" title="Copy group code">
          üìã Copy
        </button>
      </div>

      <p class="invite-text">Share this code with friends to invite them to your movie session!</p>
    </div>

    <!-- Members Section -->
    <div class="members-section">
      <div class="members-header">
        <h2 class="members-title">
          <span>üë•</span>
          Members
        </h2>
        <span id="memberCount" class="member-count">0</span>
      </div>

      <div id="membersList" class="members-list">
        <div class="loading">Loading members...</div>
      </div>
    </div>

    <!-- Actions -->
    <div class="lobby-actions">
      <button id="startMatchingBtn" class="btn-primary">
        ‚ñ∂Ô∏è Start Matching
      </button>
      <button id="leaveLobbyBtn" class="btn-danger">
        üö™ Leave Lobby
      </button>
    </div>

  <script>
    const groupId = '{{ group.id }}';
    const groupCode = '{{ group_code }}';
    const isCreator = {{ is_creator|yesno:"true,false" }};

    // Load Group Details
    async function loadGroupDetails() {
      try {
        const response = await fetch(`/api/groups/${groupId}`);
        const result = await response.json();

        if (result.success) {
          displayMembers(result.data.members);
          updateMemberCount(result.data.memberCount);
        } else {
          console.error('Failed to load group details:', result.message);
        }
      } catch (error) {
        console.error('Error loading group details:', error);
      }
    }

    // Display Members
    function displayMembers(members) {
      const membersList = document.getElementById('membersList');

      if (members.length === 0) {
        membersList.innerHTML = '<div class="no-members">No members yet. Share the group code to invite friends!</div>';
        return;
      }

      membersList.innerHTML = members.map(member => {
        const displayName = member.name || member.username;
        const initial = displayName.charAt(0).toUpperCase();

        return `
          <div class="member-item">
            <div class="member-info">
              <div class="member-avatar">${initial}</div>
              <div class="member-details">
                <span class="member-name">${displayName}</span>
                <span class="member-username">@${member.username}</span>
              </div>
            </div>
            <span class="member-role ${member.role.toLowerCase()}">${member.role}</span>
          </div>
        `;
      }).join('');
    }

    // Update Member Count
    function updateMemberCount(count) {
      document.getElementById('memberCount').textContent = count;
    }

    // Copy Group Code
    document.getElementById('copyCodeBtn').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(groupCode);
        const btn = document.getElementById('copyCodeBtn');
        const originalText = btn.textContent;

        btn.textContent = '‚úì Copied!';
        btn.classList.add('copied');

        setTimeout(() => {
          btn.textContent = originalText;
          btn.classList.remove('copied');
        }, 2000);
      } catch (error) {
        // Fallback for browsers that don't support clipboard API
        const textArea = document.createElement('textarea');
        textArea.value = groupCode;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          alert('Group code copied: ' + groupCode);
        } catch (err) {
          alert('Failed to copy. Group code: ' + groupCode);
        }
        document.body.removeChild(textArea);
      }
    });

    // Start Matching
    document.getElementById('startMatchingBtn').addEventListener('click', () => {
      // Áõ¥Êé•Ë∑≥ËΩ¨Âà∞ deck È°µÈù¢
      window.location.href = `/groups/${groupCode}/deck/`;
    });

    // Leave Lobby
    document.getElementById('leaveLobbyBtn').addEventListener('click', () => {
      if (confirm('Are you sure you want to leave this group?')) {
        window.location.href = '/profile/';
      }
    });

    // Load group details on page load
    loadGroupDetails();

    // Auto-refresh members list every 5 seconds
    setInterval(loadGroupDetails, 5000);
  </script>
</body>
</html>
