{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Your Genres - Solo Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body::before,
        body::after {
            content: '';
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        body::before {
            background: radial-gradient(circle at 20% 50%, rgba(229, 9, 20, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(229, 9, 20, 0.1) 0%, transparent 50%);
        }

        body::after {
            background: radial-gradient(circle at 60% 20%, rgba(255, 10, 22, 0.08) 0%, transparent 50%);
        }

        .genre-card {
            transition: all 0.3s ease;
            cursor: pointer;
            outline: none;
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(10px);
        }
        .genre-card:hover, .genre-card:focus-visible {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(229, 9, 20, 0.3);
            border-color: #E50914;
        }
        .genre-card.selected {
            background: linear-gradient(135deg, #E50914 0%, #ff0a16 100%);
            color: white;
            transform: scale(1.05);
            border-color: #ff0a16;
        }
        .genre-card.selected:hover, .genre-card.selected:focus-visible {
            transform: translateY(-4px) scale(1.05);
        }
    </style>
</head>
<body style="background: #141414; min-height: 100vh; color: #fff;">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-5xl font-bold mb-4">Go Solo</h1>
            <p class="text-xl" style="color: #ccc;">Pick your favorite genres and discover amazing movies!</p>
            <p class="text-sm mt-2" style="color: #999;">Select at least one genre to continue</p>
        </div>

        <!-- Genre Grid -->
        <div class="max-w-6xl mx-auto mb-8">
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                {% for genre in genres %}
                <div class="genre-card rounded-lg p-6 text-center border border-gray-800"
                     role="button" tabindex="0"
                     data-genre-id="{{ genre.id }}"
                     onclick="toggleGenre(this, this.dataset.genreId)"
                     onkeydown="if(event.key==='Enter' || event.key===' ') { event.preventDefault(); toggleGenre(this, this.dataset.genreId); }">
                    <div class="text-4xl mb-2">
                        {% if genre.name == "Action" %}âš¡
                        {% elif genre.name == "Comedy" %}ğŸ˜‚
                        {% elif genre.name == "Drama" %}ğŸ­
                        {% elif genre.name == "Horror" %}ğŸ‘»
                        {% elif genre.name == "Romance" %}ğŸ’•
                        {% elif genre.name == "Thriller" %}ğŸ”ª
                        {% elif genre.name == "Science Fiction" %}ğŸš€
                        {% elif genre.name == "Animation" %}ğŸ¨
                        {% elif genre.name == "Adventure" %}ğŸ—ºï¸
                        {% elif genre.name == "Fantasy" %}ğŸ§™
                        {% elif genre.name == "Crime" %}ğŸ•µï¸
                        {% elif genre.name == "Mystery" %}ğŸ”
                        {% elif genre.name == "Documentary" %}ğŸ“¹
                        {% elif genre.name == "Family" %}ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦
                        {% elif genre.name == "Music" %}ğŸµ
                        {% elif genre.name == "History" %}ğŸ“œ
                        {% elif genre.name == "War" %}âš”ï¸
                        {% elif genre.name == "Western" %}ğŸ¤ 
                        {% else %}ğŸ¬
                        {% endif %}
                    </div>
                    <h3 class="text-lg font-semibold">{{ genre.name }}</h3>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Selected Count -->
        <div class="text-center mb-6">
            <p class="text-lg">
                Selected: <span id="selected-count" class="font-bold" style="color: #E50914;">0</span> genres
            </p>
        </div>

        <!-- Continue Button -->
        <div class="text-center">
            <button id="continue-btn"
                    class="px-8 py-4 rounded-full text-lg font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                    style="background: #E50914; color: white;"
                    onmouseover="if(!this.disabled) this.style.background='#ff0a16'"
                    onmouseout="this.style.background='#E50914'"
                    onclick="continueToSwipe()"
                    disabled>
                Continue to Movies â†’
            </button>
        </div>

        <!-- Back Button -->
        <div class="text-center mt-4">
            <a href="{% url 'recom_sys:profile' %}" style="color: #999;" class="hover:text-white transition-colors">
                â† Back to Profile
            </a>
        </div>
    </div>

    <script>
        // Keep IDs as numbers inside the Set to avoid "1" vs 1 mismatches
        const selectedGenres = new Set();
        const continueBtn = document.getElementById('continue-btn');
        const selectedCount = document.getElementById('selected-count');

        function toggleGenre(element, genreId) {
            const idNum = Number(genreId);

            if (selectedGenres.has(idNum)) {
                selectedGenres.delete(idNum);
                element.classList.remove('selected');
            } else {
                selectedGenres.add(idNum);
                element.classList.add('selected');
            }

            updateUI();
        }

        function updateUI() {
            selectedCount.textContent = selectedGenres.size;
            continueBtn.disabled = selectedGenres.size === 0;
        }

        async function continueToSwipe() {
            if (selectedGenres.size === 0) {
                alert('Please select at least one genre');
                return;
            }

            const genresArray = Array.from(selectedGenres);

            try {
                const response = await fetch('/api/solo/set-genres/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ genres: genresArray })
                });

                const data = await response.json();

                if (data.success) {
                    window.location.href = data.redirect_url;
                } else {
                    alert(data.message || 'Failed to save genres');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>
