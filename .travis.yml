language: python
dist: jammy
python:
  - "3.11"
  - "3.12"

# Services
services:
  - docker
  - redis-server

# Environment variables
env:
  global:
    - CI=1
    - POSTGRES_DB=cinematch_test
    - POSTGRES_USER=postgres
    - POSTGRES_PASSWORD=postgres
    - PGHOST=127.0.0.1
    - PGPORT=5432
    - DATABASE_URL=postgres://postgres:postgres@127.0.0.1:5432/cinematch_test
    - DJANGO_SETTINGS_MODULE=recommendation_sys.settings
    - SECRET_KEY=test-secret-key-for-travis

# Cache dependencies
cache:
  directories:
    - $HOME/.cache/pip

# Before install - Setup PostgreSQL 14 via Docker
before_install:
  - docker run --name pg14 -e POSTGRES_PASSWORD=$POSTGRES_PASSWORD -e POSTGRES_DB=$POSTGRES_DB -p 5432:5432 -d postgres:14
  - for i in {1..40}; do docker exec pg14 pg_isready -U $POSTGRES_USER >/dev/null 2>&1 && break; sleep 1; done
  - docker exec pg14 psql -U $POSTGRES_USER -d $POSTGRES_DB -c "select version();"

# Install dependencies
install:
  - pip install --upgrade pip
  - pip install -r requirements.txt
  - pip install pytest pytest-django pytest-asyncio pytest-cov black flake8 coverage coveralls

# Pre-submit CI - runs on every push
script:
  - black --check .
  - flake8 . --max-line-length=120 --exclude=migrations,__pycache__,venv,env --config=.flake8 || true
  - python manage.py makemigrations --check --dry-run
  - python manage.py migrate --noinput
  - coverage run --source='recom_sys_app' manage.py test recom_sys_app
  - pytest recom_sys_app/ -v --cov=recom_sys_app

# Send coverage to Coveralls
after_success:
  - coveralls --service=travis-pro

# Post-submit CI - cron job (runs once a day on main branch)
# Configure in Travis settings: https://app.travis-ci.com/github/gcivil-nyu-org/team4-mon-fall25/settings

# CD Deployment - Auto-deploy to AWS when tests pass
deploy:
  provider: elasticbeanstalk
  access_key_id: $AWS_ACCESS_KEY_ID
  secret_access_key: $AWS_SECRET_ACCESS_KEY
  region: us-east-1
  app: cinematch-app
  env: cinematch-production
  on:
    branch: develop

# Notifications
notifications:
  email:
    recipients:
      - your-team-email@example.com  # Update with actual team email
    on_success: change
    on_failure: always