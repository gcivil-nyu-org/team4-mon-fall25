language: python
dist: jammy  # Ubuntu 22.04 has PostgreSQL 14 by default (focal has 13.21)
python:
  - "3.11"
  - "3.12"

# Services
services:
  - postgresql
  - redis-server

# Environment variables
env:
  global:
    - CI=1
    - POSTGRES_DB=cinematch_test
    - POSTGRES_USER=postgres
    - POSTGRES_PASSWORD=postgres
    - DJANGO_SETTINGS_MODULE=recommendation_sys.settings
    - SECRET_KEY=test-secret-key-for-travis
    - TMDB_TOKEN=dummy-token-for-testing  # Required for API tests (mocked)

# Cache dependencies
cache:
  directories:
    - $HOME/.cache/pip

# Before install - Setup PostgreSQL
before_install:
  - sudo -u postgres psql -c "CREATE DATABASE cinematch_test;"
  - sudo -u postgres psql -c "ALTER USER postgres WITH PASSWORD 'postgres';"

# Install dependencies
install:
  - pip install --upgrade pip
  - pip install -r requirements.txt
  - pip install pytest pytest-django pytest-asyncio pytest-cov black flake8 coverage coveralls

# Pre-submit CI - runs on every push
script:
  - black --check .
  - flake8 . --max-line-length=120 --exclude=migrations,__pycache__,venv,env --config=.flake8 || true
  - python manage.py makemigrations --check --dry-run
  - python manage.py migrate --noinput
  - coverage run --source='recom_sys_app' manage.py test recom_sys_app
  - pytest recom_sys_app/ -v --cov=recom_sys_app

# Send coverage to Coveralls
after_success:
  - coveralls --service=travis-pro

# Post-submit CI - cron job (runs once a day on main branch)
# Configure in Travis settings: https://app.travis-ci.com/github/gcivil-nyu-org/team4-mon-fall25/settings

# CD Deployment - Auto-deploy to AWS when tests pass
# Disabled until AWS environment is configured
# deploy:
#   provider: elasticbeanstalk
#   access_key_id: $AWS_ACCESS_KEY_ID
#   secret_access_key: $AWS_SECRET_ACCESS_KEY
#   region: us-east-1
#   app: cinematch-app
#   env: cinematch-production
#   bucket_name: elasticbeanstalk-us-east-1-YOUR_ACCOUNT_ID
#   bucket_path: cinematch-app
#   on:
#     branch: develop

# Notifications
notifications:
  email:
    recipients:
      - your-team-email@example.com  # Update with actual team email
    on_success: change
    on_failure: always